#!/bin/bash
#

set -e

function printq {
  echo "$(tput setaf 114; tput bold)$1$(tput sgr0)"
}

# Adapt script to given board
case $1 in

  lars)
    export SND_CONFIG=0;
    export SND_BOARD=lars;
    export SND_MODULE=snd_skl_nau88l25_max98357a;
    export SND_CARD=sklnau8825max;
    export SND_DEVICE=sklnau8825max;
    ;;

  cave)
    export SND_CONFIG=0;
    export SND_BOARD=cave;
    export SND_MODULE=snd_skl_nau88l25_max98357a;
    export SND_CARD=sklnau8825max;
    export SND_DEVICE=sklnau8825max;
    ;;

  woomax)
    export SND_CONFIG=1;
    export SND_BOARD=woomax;
    export SND_MODULE=snd_soc_max98357a;
    export SND_CARD=acp3xalc5682m98357;
    export SND_DEVICE=acp3xalc5682m98357.woomax;
    ;;

  nami)
    export SND_CONFIG=1;
    export SND_BOARD=nami;
    export SND_MODULE=snd_soc_kbl_da7219_max98357a;
    export SND_CARD=kblda7219max;
    export SND_DEVICE=kblda7219max.nami;
    ;;


  coral)
    export SND_CONFIG=1;
    export SND_BOARD=coral;
    export SND_MODULE=snd_soc_sst_bxt_da7219_max98357a;
    export SND_CARD=bxtda7219max;
    export SND_DEVICE=bxtda7219max.coral;
    ;;

  sof)
    export SND_CONFIG=2;
    export SND_MODULES="snd_soc_max98357a snd_soc_da7219";
    ;;

  sof-rtk)
    export SND_CONFIG=2;
    export SND_MODULES="snd_soc_max98357a snd_soc_rt5682";
    ;;

  *)
    echo "Your board is not recognized, please open an issue."
    echo "You can also try with sof or sof-rtk, maybe it will work."
    exit
    ;;
esac

printq "Installing Audio on $1"

# Remove PulseAudio
sudo apt purge pulseaudio -y
sudo apt purge pulseaudio* -y

if [[ "$SND_CONFIG" -eq 0 ]] || [[ "$SND_CONFIG" -eq 1 ]]; then


    # Copy the firmware and create the correct UCM Files
    sudo umount /mnt || true
    sudo mount -t ext2 -o ro /dev/mmcblk0p3 /mnt || sudo mount -t ext2 -o ro /dev/mmcblk1p3 /mnt || sudo mount -t ext2 -o ro /dev/nvme0n1p3 /mnt
    sudo cp -rv /mnt/lib/firmware/* /lib/firmware
    sudo rm -rf /usr/share/alsa/ucm2/${SND_CARD} || true
    sudo cp -rv /mnt/usr/share/alsa/ucm*/${SND_DEVICE} /usr/share/alsa/ucm2/${SND_CARD}
    sudo umount /mnt
    if [[ "$SND_CONFIG" -eq 1 ]]; then
        sudo mv /usr/share/alsa/ucm2/${SND_CARD}/${SND_DEVICE}.conf /usr/share/alsa/ucm2/${SND_CARD}/${SND_CARD}.conf
    fi
    sudo sed -i '1s/^/Syntax 2\n/' /usr/share/alsa/ucm2/${SND_CARD}/${SND_CARD}.conf
    sudo sed -i '/Pin/{/Mux/ d}' /usr/share/alsa/ucm2/${SND_CARD}/HiFi.conf
    # Check if user has the newer UCM directory layout
    ls /usr/share/alsa/ucm2/conf.d && {
        sudo mv /usr/share/alsa/ucm2/${SND_CARD} /usr/share/alsa/ucm2/conf.d
    }

    sudo apt install -y alsa-base alsa-utils apulse

    # Add a systemd service to start sound
    sudo tee /etc/systemd/system/alsa-reload.service <<EOF
[Unit]
Description="Reload ALSA and set the correct UCM"

[Service]
User=root
WorkingDirectory=/
ExecStart=/bin/bash -c 'modprobe ${SND_MODULE} && alsa reload && sleep 2 && alsaucm -c ${SND_CARD} set _verb HiFi set _enadev Speaker'

[Install]
WantedBy=multi-user.target
EOF
fi 
if [[ "$SND_CONFIG" -eq 2 ]]; then
    sudo apt install -y apulse alsa-* rsync
    sudo apt install -y firmware-sof-signed || sudo apt-get -o Dpkg::Options::="--force-overwrite" install firmware-sof-signed
    sudo tee /etc/systemd/system/alsa-reload.service <<EOF
[Unit]
Description="Reload ALSA and set the correct UCM"

[Service]
User=root
WorkingDirectory=/
ExecStart=/bin/bash -c 'modprobe ${SND_MODULES} && alsa reload'

[Install]
WantedBy=multi-user.target
EOF
fi

# Enable Dmix (multiple app audio output) and software master volume control
sudo tee /etc/asound.conf <<EOF
pcm.!default {
    type plug
    slave.pcm "softvol"
}

pcm.softvol {
    type softvol # Software volume control
    slave {
        pcm "dmix"
    }
    control {
        name "Master"
        card 0
    }
}
EOF

# Refresh systemd
sudo systemctl daemon-reload
sudo systemctl enable alsa-reload

# Replace PulseAudio libraries with Apulse, which makes PulseAudio apps work with ALSA
for lib in libpulse-mainloop-glib.so libpulse-simple.so libpulse.so; do

    set +e
    sudo rm -f /usr/lib/${lib} /usr/lib/${lib}.0 /usr/lib/x86_64-linux-gnu/${lib} /usr/lib/x86_64-linux-gnu/${lib}.0
    set -e
        
    sudo ln -s /usr/lib/x86_64-linux-gnu/apulse/${lib}   "/usr/lib/${lib}"
    sudo ln -s /usr/lib/x86_64-linux-gnu/apulse/${lib}.0 "/usr/lib/${lib}.0"
    sudo ln -s /usr/lib/x86_64-linux-gnu/apulse/${lib}   "/usr/lib/x86_64-linux-gnu/${lib}"
    sudo ln -s /usr/lib/x86_64-linux-gnu/apulse/${lib}.0 "/usr/lib/x86_64-linux-gnu/${lib}.0"
        
done

if [[ "$SND_CONFIG" -eq  2 ]]; then
    sudo rm -rfv /lib/firmware/intel/sof* # Symlinks can conflict
    cd # to home directory
    git clone --depth 1 "https://github.com/thesofproject/sof-bin"
    cd sof-bin/v2.1.x
    sudo rsync -a sof*v2.1.1   /lib/firmware/intel/
    sudo ln -s sof-v2.1.1      /lib/firmware/intel/sof
    sudo ln -s sof-tplg-v2.1.1 /lib/firmware/intel/sof-tplg
    sudo rsync tools-v2.1.1/*  /usr/local/bin

    # SOF doesn't need SST/HDA drivers, especially on Chromebooks where they conflict
    echo 'blacklist snd_hda_intel' | sudo tee /etc/modprobe.d/alsa-disable-sst.conf
fi

if [[ "$SND_CONFIG" -eq  0 ]]; then
    VERSION=ALT updatekernel-on-emmc
fi

printq "Configuring Pipewire..."

# Install pipewire libraries and alsa client
sudo apt install libspa-0.2-bluetooth libspa-0.2-jack libspa-0.2-modules
sudo apt install pipewire-audio-client-libraries
sudo apt install wireplumber pipewire-media-session-

# Configure wireplumber service and alsa 
systemctl --user --now enable wireplumber.service
sudo cp /usr/share/doc/pipewire/examples/alsa.conf.d/99-pipewire-default.conf /etc/alsa/conf.d/

sync
printq 'Done! Reboot to enable audio'
